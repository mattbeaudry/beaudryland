/*////////////////////////
//
//	Beaudryland 4
//  
//	Matt Beaudry
//	
//	February 15, 2013
//	
////////////////////////*/

var blocktypes = new Array(
	/*grass map*/	"grass", "dirt", "water", "tree", "rock", "hole",
	/*snow map*/  	"snow", "frozendirt", "ice", "pinetree", "icerock", "snowhole",
	/*items*/     	"wood", "shovel", "sword", "guitar", "fire", "door", "frisbee", "bike", "skiis",
	/*treasure*/  	"diamond", "diamond-hole", "gold", "gold-hole", "silver", "silver-hole"
);

var blockclasses = "block block-tree block-wood block-rock block-shovel block-fire block-door";
var inventoryslots = 30;
var gridunitpx = 20; //must change this px value in css as well
var mapwidth = 40;
var mapheight = 30;
var enemyspeed = 300;
var projectilespeed = 50;
var bikespeed = 100;

var totalmapblocks = mapwidth * mapheight;
var mapwidthpx = mapwidth * gridunitpx;
var mapheightpx = mapheight * gridunitpx;

/*
preloadImages = function() {
    $('body img').each(function(){
        $('<img/>')[0].src = this;
    });
}
preloadImages();
*/


/////////////
//build/save the map
/////////////


loadGame = function(){

	console.log("load game");

    $.post('php/loadmap.php', {maptype:'forest'}, function(data) {

    	if (data == false){
    		console.log("new user");
    		loadNewMap();
    		createPlayer();
    	} else {
    		loadMap('forest');
    		$.post('php/loadmap.php', {maptype:'winter'}, function(data) {
    			if (data){
    				console.log("loadwintermap");
    				loadMap('winter');
    			}
			});
			loadPlayer();
			
    	}
    	
    });
    drawNewWinterMap();
    drawNewBeachMap();
   
};
loadMap = function(maptype){

	$.post('php/loadmap.php', {maptype:maptype}, function(data) {

		console.log("existing user");
		var mapblocks = JSON.parse(data);
		var mapdata = "";
		var total = totalmapblocks + 1;
		for (i=1; i<total; i++){
			mapdata += '<div data-blockid="'+i+'" data-blocktype="'+mapblocks[i]+'" data-blockhealth="10" class="block block-'+mapblocks[i]+'"></div>';
		}
		
		if (maptype == 'forest'){
			$('.the-fucking-map').html(mapdata);
		} else if (maptype == 'winter'){
			$('.maps-wrap').append('<div class="the-fucking-winter-map" data-maptype="winter"></div>');
			$('.the-fucking-winter-map').css("width", mapwidthpx+"px");
			$('.the-fucking-winter-map').css("height", mapheightpx+"px");
			$('.the-fucking-winter-map').html(mapdata);
		}
		//$('.the-fucking-map').html(data);
		//loadPlayerInventory();
		//drawNewWinterMap();
	});
};
setMapSize = function() {
	console.log("Render Map");
	$('.the-fucking-map').css("width", mapwidthpx+"px");
	$('.the-fucking-map').css("height", mapheightpx+"px");
};
loadNewMap = function(type) {
	
	for (var f = 0; f <= (totalmapblocks - 1); f++){
		//random block generation
		var r = Math.random();
		var blocktype;
		if (r<0.7) { blocktype = "grass"; }
		else if (r>0.98) { blocktype = "rock"; }
		else if (r>0.8) { blocktype = "tree"; }
		else { blocktype = "water"; }
		$('.the-fucking-map').append('<div data-blockid="'+f+'" data-blocktype="'+blocktype+'" data-blockhealth="10" class="block block-'+blocktype+'"></div>');
	}
};
saveMap = function(){
	console.log("save map");
	
	/*
	$('.the-fucking-map div').each(function(index){
		var blocktype = $(this).attr('data-blocktype');
		mapblocks[index] = blocktype;
	});
	*/
	var playerdiv = $('.the-fucking-player').prop("outerHTML");
	$('.the-fucking-player').remove();
	
	//save forest map
	var mapblocks = new Array();
	var total = totalmapblocks;
    for (i=0; i<=total; i++){
    	var blocktype = $('.the-fucking-map div:eq('+i+')').attr('data-blocktype');
    	//growing grass and cleaning up map
    	if (blocktype == "hole") { blocktype = "grass"; }
    	if (blocktype == "dirt") { blocktype = "grass"; }
    	if (blocktype == "frozendirt") { blocktype = "grass"; }
    	if (blocktype == "icehole") { blocktype = "grass"; }
		mapblocks[i] = blocktype;
	}
	
	//save winter map
	var wintermapblocks = new Array();
	var total = totalmapblocks;
    for (i=0; i<=total; i++){
    	var blocktype = $('.the-fucking-winter-map div:eq('+i+')').attr('data-blocktype');
    	//snowing on blocks and cleaning up map
    	if (blocktype == "dirt") { blocktype = "snow"; }
    	if (blocktype == "hole") { blocktype = "snow"; }
    	if (blocktype == "frozendirt") { blocktype = "snow"; }
    	if (blocktype == "icehole") { blocktype = "snow"; }
		wintermapblocks[i] = blocktype;
	}
	
	var jsonmapblocks = JSON.stringify(mapblocks);
    $.post('php/savemap.php', {mapdata: jsonmapblocks, maptype:'forest'}, function(data) {
        //$('body').append(data);
        console.log("save mapdata: "+data);
    });
    
    if ($('.the-fucking-winter-map').length) {
    	//alert("winter map exists");
		var jsonwintermapblocks = JSON.stringify(wintermapblocks);
	    $.post('php/savemap.php', {mapdata: jsonwintermapblocks, maptype:'winter'}, function(data) {
	        //$('body').append(data);
	        console.log("save mapdata: "+data);
	    });
	    
	}
    
    $('.the-fucking-map').append(playerdiv);
    
};
drawNewBeachMap = function() {

	/* LOAD BEACH MAP FUNCTION */
	$('.maps-wrap').append('<div class="the-fucking-beach-map" data-maptype="beach"></div>');
	$('.the-fucking-beach-map').css("width", mapwidthpx+"px");
	$('.the-fucking-beach-map').css("height", mapheightpx+"px");
	var mapdata = "";
	
	var maphalf = 0.5 * mapwidth;
	var shoreedge = maphalf;
	
	
	for (var f = 0; f <= (totalmapblocks - 1); f++){
	
		//random block generation
		var r = Math.random();
		var blocktype;
		var rowposition = f % mapwidth;
		
		if (rowposition == 0) {
			shoreedge = parseInt(Math.random() * 3) + 2;
			console.log(shoreedge);
		}
		
		if (rowposition <= (maphalf-shoreedge)) {
			
			if (r<0.96) { blocktype = "sand"; }
			else if (r>0.98) { blocktype = "sandstone"; }
			else if (r>0.96) { blocktype = "palmtree"; }
			
		} else {
		
			if (r<=0.98) { blocktype = "water"; }
			else if (r>0.98) { blocktype = "wave"; }
			
		}
		
		console.log(blocktype+rowposition+maphalf);

		mapdata += '<div data-blockid="'+f+'" data-blocktype="'+blocktype+'" data-blockhealth="10" class="block block-'+blocktype+'"></div>';
		
	}
	$('.the-fucking-beach-map').html(mapdata);
	
	
	startWaves();
	
};
var wavesanimate;
stopWaves = function(){ 
	clearTimeout(wavesanimate); 
	wavesanimate = null;
};
startWaves = function(){
	
	console.log("animating the waves!");
	
	var wavespeed = 1400;
	wavesanimate = setTimeout(moveWaves, wavespeed);
	
	function moveWaves() {
		//var toprow = $('.the-fucking-winter-map div').slice(0,40).remove();
		//$('.the-fucking-beach-map .block-waves').addClass('block-water');
		//$('.the-fucking-beach-map .block-waves').removeClass('block-waves');
		
		$('.the-fucking-beach-map .block').each( function(index, value) {
		
			//if (Math.random() < 0.5){
		
				if ($(this).hasClass('block-wave')){
					
					if ($('.the-fucking-beach-map .block:eq('+(index-1)+')').hasClass('block-water')) {
					
						//wave has not reached the shore yet
						var newtype = 'wave';
						//console.log("changing block "+(index-1)+" to "+newtype);
						$('.the-fucking-beach-map .block:eq('+(index-1)+')').removeClass("block-grass block-rock block-dirt block-fire block-water block-tree block-hole block-wood block-door-closed block-door-open block-diamond-hole block-diamond block-gold-hole block-gold block-pinetree block-icerock block-ice block-snow block-snowhole block-frozendirt block-palmtree block-sandstone block-sand block-wave");
						$('.the-fucking-beach-map .block:eq('+(index-1)+')').addClass("block block-"+newtype);
						$('.the-fucking-beach-map .block:eq('+(index-1)+')').attr("data-blocktype", newtype);
												
					} else {
						
						//wave has reached the shore, create new wave at edge of map
						//var rowremainder = (index-1) % mapwidth;
						//alert(rowremainder);
						
						var r = parseInt(Math.random() * mapheight);
						var newwaveposition = (r * mapwidth) - 1;r
						var newtype = "wave";
						
						//console.log("new wave at block "+newwaveposition);
						
						$('.the-fucking-beach-map .block:eq('+newwaveposition+')').removeClass("block-grass block-rock block-dirt block-fire block-water block-tree block-hole block-wood block-door-closed block-door-open block-diamond-hole block-diamond block-gold-hole block-gold block-pinetree block-icerock block-ice block-snow block-snowhole block-frozendirt block-palmtree block-sandstone block-sand block-wave");
						$('.the-fucking-beach-map .block:eq('+newwaveposition+')').addClass("block block-"+newtype);
						$('.the-fucking-beach-map .block:eq('+newwaveposition+')').attr("data-blocktype", newtype);
					
					}
					
					newtype = 'water';
					//console.log("changing block "+index+" to "+newtype);
					$('.the-fucking-beach-map .block:eq('+index+')').removeClass("block-grass block-rock block-dirt block-fire block-water block-tree block-hole block-wood block-door-closed block-door-open block-diamond-hole block-diamond block-gold-hole block-gold block-pinetree block-icerock block-ice block-snow block-snowhole block-frozendirt block-palmtree block-sandstone block-sand block-wave");
					$('.the-fucking-beach-map .block:eq('+index+')').addClass("block block-"+newtype);
					$('.the-fucking-beach-map .block:eq('+index+')').attr("data-blocktype", newtype);
					
					/*
					changeBlockType(index-1, 'wave');
					changeBlockType(index, 'water');
					*/	
			  	}	
			  	//alert(index + ': ' + value);
		  	//}
		  	
		});
		
		wavesanimate = setTimeout(moveWaves, wavespeed); // repeat thought
	}
};

drawNewWinterMap = function() {

	/* LOAD WINTER MAP FUNCTION */
	$('.maps-wrap').append('<div class="the-fucking-winter-map" data-maptype="winter"></div>');
	$('.the-fucking-winter-map').css("width", mapwidthpx+"px");
	$('.the-fucking-winter-map').css("height", mapheightpx+"px");
	var mapdata = "";
	for (var f = 0; f <= (totalmapblocks - 1); f++){
		//random block generation
		var r = Math.random();
		var blocktype;
		if (r<0.9) { blocktype = "snow"; }
		else if (r>0.98) { blocktype = "icerock"; }
		else if (r>0.96) { blocktype = "pinetree"; }
		else { blocktype = "ice"; }
		mapdata += '<div data-blockid="'+f+'" data-blocktype="'+blocktype+'" data-blockhealth="10" class="block block-'+blocktype+'"></div>';
	}
	$('.the-fucking-winter-map').html(mapdata);
};
var mapanimate;
stopMap = function(){ 
	clearTimeout(mapanimate); 
	mapanimate = null;
};
moveMap = function(){
	console.log("animating the map!");
	
	//var toprow = $('.the-fucking-winter-map div').slice(40).remove();
	//$('.the-fucking-winter-map').append(toprow);
	
	//var toprow = $('.the-fucking-map div').slice(-40).remove();
	//$('.the-fucking-winter-map').prepend(toprow);
	
	var mapspeed = 200;
	mapanimate = setTimeout(scrollMap, mapspeed);
	
	function scrollMap() {
		var toprow = $('.the-fucking-winter-map div').slice(0,40).remove();
		$('.the-fucking-winter-map').append(toprow);
		mapanimate = setTimeout(scrollMap, mapspeed); // repeat thought
	}
};


/////////////
//create the player
/////////////


createPlayer = function(id) {
	console.log("Create Player");
	//var playerstartblock = 466;
	//changeBlockType(playerstartblock, "grass"); //make sure player doesn't start overtop an obstacle
	
	$('.the-fucking-map').append('<div class="the-fucking-player player-direction-down"></div>');
};

savePlayer = function() {

	var playerdiv = $('.the-fucking-player').prop("outerHTML");
	//playerdiv = playerdiv.toString();
	var selecteditem = $('.the-fucking-inventory .selected-item').attr("data-blocktype");
	//var selecteditem = "sword";
	
	console.log("playerdiv"+playerdiv);
	console.log("seleted item"+selecteditem);
	
	/*
	$.post('php/saveplayerdata.php', {playerdiv: playerdiv, selecteditem: selecteditem }, function(data) {
    
        //$('body').append(data);
        console.log("save mapdata: "+data);
        
    });
    */
    
    var inventoryItems = new Array();
	for (i=1; i<=inventoryslots; i++){ 
		inventoryItems[i]=new Object(); 
	}
	
	$('.the-fucking-inventory > div').each(function(index){
		var amount = $(this).html();
		var blocktype = $(this).attr('data-blocktype');
		console.log("inventory slot "+index+" = "+amount+blocktype);
		inventoryItems[index] = {type:blocktype, amount:amount};
	});

	console.log("saved inventory = "+inventoryItems);
	inventoryItems = JSON.stringify(inventoryItems);
	
	$.post('php/saveplayer.php', {inventory: inventoryItems, playerdiv: playerdiv, selecteditem: selecteditem }, function(data) {

        console.log("saved player: "+data);
        
    });
	
};

loadPlayer = function() {

	console.log("loadplayer");
	
	$.post('php/loadplayer.php', {}, function(data) {
    	
    	var inventoryitems = JSON.parse(data.inventory);
    	var playerdiv = data.playerdiv;
    	var selecteditem = data.selecteditem;
    	
    	console.log("loading playerdiv");
    	$('.the-fucking-map').append(playerdiv);
    	
        console.log("loading inv");
    	for (var i = 0; i < (inventoryitems.length-1); i++) {
    	
    		$('.the-fucking-inventory > div:eq('+i+')').html(inventoryitems[i].amount);
    		
    		if (inventoryitems[i].amount !== "0"){
    			$('.the-fucking-inventory > div:eq('+i+')').attr('data-blocktype', inventoryitems[i].type);
    			$('.the-fucking-inventory > div:eq('+i+')').removeClass('empty');
    			$('.the-fucking-inventory > div:eq('+i+')').addClass('block block-'+inventoryitems[i].type);
    		}
    		
		}
		
		console.log("loading selected item");
    	$('.the-fucking-inventory div').not('.the-fucking-inventory .block-'+selecteditem).removeClass('selected-item');
    	$('.the-fucking-inventory .block-'+selecteditem).addClass('selected-item');
        
    }, "json");
	
};


/////////////
//artificial intelligence
/////////////


createEnemy = function(id) {

	console.log("Create Enemy "+id);
	//var enemystartblock = 0;
	$('.the-fucking-map').append('<div class="the-fucking-enemy enemy-direction-down"></div>');
	initEnemyBrain(id);
	
};

initEnemyBrain = function(id) {

	console.log("start brain program for enemy #"+id);
	
	var t = 0;
	var maxthoughts = 500;
	var enemybrain = setTimeout(anEnemyThought, enemyspeed);
	
	function anEnemyThought() {
		
		var enemyrandom = Math.random();
		//var enemydirection;
		var enemyX = getObjectCurrentCol("enemy"); var enemyY = getObjectCurrentRow("enemy");
		var playerX = getObjectCurrentCol("player"); var playerY = getObjectCurrentRow("player");
		var PEx = playerX - enemyX; var PEy = enemyY - playerY;
		var posPEx = Math.abs(PEx); var posPEy = Math.abs(PEy);
		
		if ( (PEx == 0) && (PEy == 0)){
		
			//console.log("PEx:"+PEx+" PEy:"+PEy+" found the player, kill player!");
			console.log("found, the player, kill player!"); 
	
		} else if (posPEx >= posPEy) {
		
			if (PEx >= 0) { 
				//console.log("PEx:"+PEx+" PEy:"+PEy+" player is east"+posPEx+"<"+posPEy); 
				moveObjectRight("enemy");
			} else { 
				//console.log("PEx:"+PEx+" PEy:"+PEy+" player is west"+posPEx+"<"+posPEy); 
				moveObjectLeft("enemy");
			}
			
		} else {
		
			if (PEy >= 0) { 
				//console.log("PEx:"+PEx+" PEy:"+PEy+"player is north"+posPEx+">"+posPEy); 
				moveObjectUp("enemy");
			} else { 
				//console.log("PEx:"+PEx+" PEy:"+PEy+"player is south"+posPEx+">"+posPEy); 
				moveObjectDown("enemy");
			}
			
		}
	
		/*
		//RANDOM ENEMY MOVEMENT
		if (enemyrandom<=0.25) { moveObjectUp("enemy"); }
		else if (enemyrandom>=0.5) { moveObjectDown("enemy"); }
		else if (enemyrandom>=0.75) { moveObjectRight("enemy"); }
		else { moveObjectLeft("enemy"); }
		*/
		
		//limit
		
		if (t > maxthoughts) {
			console.log("Enemy terminated");
			//stopEnemyBrain();
			killEnemy();
		} else {
			t++;
			enemybrain = setTimeout(anEnemyThought, enemyspeed); // repeat thought
		}
		
	}
	
	function stopEnemyBrain() {
		clearTimeout(enemybrain);
	}
	
};

killEnemy = function(id) {

	console.log("Kill Enemy "+id);
	//var enemystartblock = 0;
	//clearTimeout(enemybrain);
	$('.the-fucking-enemy').remove();
	
};

/////////////
//keyboard events
/////////////

setupKeyboardEvents = function() {

	console.log("Keyboard Events");
	
	window.addEventListener('keydown', function(event) {
	
		var selecteditem = getSelectedItem();
	
		switch (event.keyCode) {
		
			case 37: /* LEFT ARROW */
				if (selecteditem == "guitar") { playGuitarSound(880); } 
				else if (selecteditem == "bike") { rideBike("left"); } 
				else if (selecteditem == "skiis") { rideSkiis("left"); }
				else { moveObjectLeft("player"); }
				break;
			case 38: /* UP ARROW */
				if (selecteditem == "guitar") { playGuitarSound(1320); } 
				else if (selecteditem == "bike") { rideBike("up"); } 
				else if (selecteditem == "skiis") { rideSkiis("up"); }
				else { moveObjectUp("player"); }
				break;
			case 39: /* RIGHT ARROW */
				if (selecteditem == "guitar") { playGuitarSound(1100); } 
				else if (selecteditem == "bike") { rideBike("right"); } 
				else if (selecteditem == "skiis") { rideSkiis("right"); }
				else { moveObjectRight("player"); }
				break;
			case 40: /* DOWN ARROW */
				if (selecteditem == "guitar") { playGuitarSound(660); } 
				else if (selecteditem == "bike") { rideBike("down"); } 
				else if (selecteditem == "skiis") { rideSkiis("down"); }
				else { moveObjectDown("player"); }
				break;
			case 32: /* SPACE */
				playerPrimaryAction(); 
				break;
			case 77: /* M */
				createEnemy();
				break;
			case 75: /* K */
				killEnemy(1);
				break;
			case 66: /* B */
				saveMap();
				break;
			case 67: /* C */
				loadMap();
				break;
			case 65: /* A */
				moveMap();
				break;
			case 68: /* D */
				stopMap();
				break;
			case 69: /* E */
				playMusic();
				break;
			case 13: /* ENTER */
				drawThoughtBubble("player","Hello!");
				break;
			case 70: /* F */
				startWaves();
				break;
			
				/*
				g 71
				h 72
				i 73
				*/
				
		}
		
	}, false);

	//prevent keys from scrolling page
	$(document).keydown(function (e) {
	    var key = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
	    if ( ((key == 37) || (key == 38) || (key == 39) || (key == 40) || (key == 32)) && (e.target.className != null))
	       e.preventDefault();
	});

};

drawThoughtBubble = function(object, text) {

	$('.the-fucking-'+object).append('<div class="speech-bubble"><form class="bubble-form"><textarea class="bubble-text" rows="1" cols="30"></textarea></form></div>');
	$('.bubble-form').submit(function(e) { 
		//e.preventDefault(); 
	});
	$('.bubble-text').focus();
	
	//setTimeout('$(".speech-bubble").remove();', 1000);
	
};

var ridingbike;
rideBike = function(direction) {
	stopBiking();
	var playerdirection = getObjectDirection("player");
	if (playerdirection == "left" && direction == "right"){ 
		changeObjectDirection("player", "right");
	} else if (playerdirection == "right" && direction == "left"){ 
		changeObjectDirection("player", "left");
	} else if (playerdirection == "up" && direction == "down"){ 
		changeObjectDirection("player", "down");
	} else if (playerdirection == "down" && direction == "up"){ 
		changeObjectDirection("player", "up");
	} else {
		ridingbike = setTimeout(function() {
			startBiking(direction);
		}, bikespeed);
	}
};
startBiking = function (direction) {
	console.log("move bike "+direction);
	var playerdirection = getObjectDirection("player");
	console.log("player current direction: "+playerdirection);
	switch (direction) {
		case "up": moveObjectUp("player"); break;
		case "down": moveObjectDown("player"); break;
		case "left": moveObjectLeft("player"); break;
		case "right": moveObjectRight("player"); break;
	}
	ridingbike = setTimeout(function() {
    	startBiking(direction);
	}, bikespeed); // repeat movement
};
stopBiking = function () {
	clearTimeout(ridingbike);
};
rideSkiis = function(direction) {
	if (direction == "up"){
		moveObjectUp("player");
		changeObjectDirection("player","up");
		stopMap();
	} else {
		switch (direction) {
			case "up": moveObjectUp("player"); break;
			case "down": moveObjectDown("player"); break;
			case "left": moveObjectLeft("player"); break;
			case "right": moveObjectRight("player"); break;
		}
		if (mapanimate == null) {
			moveMap();
		}
	}
};


/////////////
//click events
/////////////


setupMouseEvents = function() {

	console.log("Mouse Events");
	
	$('.the-fucking-inventory > div').on("click", function() {
	
		var blocktype = $(this).attr('data-blocktype');
		
		//items not included in crafting recipes
		if ((blocktype == "sword") || (blocktype == "shovel") || (blocktype == "fire") || 
			(blocktype == "bike") || (blocktype == "skiis") || (blocktype == "sword") ||
			(blocktype == "guitar") ||
			
			(blocktype == "dirt") || (blocktype == "grass") || (blocktype == "water") || 
			(blocktype == "frozendirt") || (blocktype == "snow") || (blocktype == "ice")
						
			){
		    
		} else {
			if ( $(this).attr('data-blocktype') != "empty" ){
				var blocktype = $(this).attr('data-blocktype');
				moveItemToCraftingTable(blocktype);
			}
		}
	
		var playerdirection = getObjectDirection("player");
		$('.the-fucking-inventory > div').removeClass("selected-item");
		$(this).addClass('selected-item');
		var selecteditem = $(this).attr('data-blocktype');
		
		if ( selecteditem == "sword" ) { createEnemy(); }
		
		if ( selecteditem == "sword" || selecteditem == "shovel" || selecteditem == "bike" || selecteditem == "skiis" ){
			console.log("selected item has animation");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-sword");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-shovel");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-sword-swing");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-shovel-swing");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-bike");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-skiis");
			$('.the-fucking-player').addClass("player-direction-"+playerdirection+"-"+selecteditem);
		} else {
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-sword");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-shovel");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-bike");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-skiis");
			$('.the-fucking-player').removeClass("player-direction-"+playerdirection+"-"+selecteditem);
		}
	
	});
	
	$('.the-fucking-crafting-table > div').on("click", function() {
		
		var blocktype = $(this).attr('data-blocktype');
		
		if (blocktype != "empty"){
			console.log("crafting slot not empty");
			$(this).removeClass("block block-"+blocktype);
			$(this).addClass("empty");
			$(this).attr('data-blocktype', "empty");
			$(this).html("0");
			
			addToInventory(blocktype,"1");
			checkCraftingTableForItem();
		}
	
	});
	
	$('.the-fucking-crafted-item > div').on("click", function() {
		
		if (!$('.the-fucking-crafted-item > div').hasClass("empty")){
		
			var blocktype = $(this).attr('data-blocktype');
			var itemquantity = $(this).html();
			console.log("You crafted" + itemquantity + " " + blocktype);
			
			$('.the-fucking-crafted-item > div').removeClass("block block-tree block-wood block-fire block-sword block-rock block-shovel block-door-closed block-guitar block-frisbee block-bike block-skiis");
			$('.the-fucking-crafted-item > div').html("0");
			
			removeAllItemsFromCraftingTable();
			addToInventory(blocktype, itemquantity);
			checkCraftingTableForItem();
			
		}
		
	});
	
	$('.link-savemap').on("mousedown", function(){
		$('.link-savemap').html('<span><strong>saving game…</strong></span>');
		enableSaving = function() {
			$('.link-savemap').html('<a>save game</a>');
		};
		setTimeout(enableSaving, 6000);
		savePlayer();
		saveMap();

	});
	
};

/////////////
//control pad for mobile
/////////////

setupControlPadEvents = function() {

	console.log("Control Pad Events");
	
	var selecteditem;
	//alert(selecteditem);
	
	$('.btn-up').on("touchstart", function() { 
		selecteditem = getSelectedItem();
		if (selecteditem == "guitar") { playGuitarSound(1320); } 
		else if (selecteditem == "bike") { rideBike("up"); } 
		else if (selecteditem == "skiis") { rideSkiis("up"); }
		else { moveObjectUp("player"); }
	});
	
	$('.btn-down').on("touchstart", function() { 
		selecteditem = getSelectedItem();
		if (selecteditem == "guitar") { playGuitarSound(660); } 
		else if (selecteditem == "bike") { rideBike("down"); } 
		else if (selecteditem == "skiis") { rideSkiis("down"); }
		else { moveObjectDown("player"); } 
	});
	
	$('.btn-left').on("touchstart", function() { 
		selecteditem = getSelectedItem();
		if (selecteditem == "guitar") { playGuitarSound(880); } 
		else if (selecteditem == "bike") { rideBike("left"); } 
		else if (selecteditem == "skiis") { rideSkiis("left"); }
		else { moveObjectLeft("player"); }
	});
	
	$('.btn-right').on("touchstart", function() { 
		selecteditem = getSelectedItem();
		if (selecteditem == "guitar") { playGuitarSound(1100); } 
		else if (selecteditem == "bike") { rideBike("right"); } 
		else if (selecteditem == "skiis") { rideSkiis("right"); }
		else { moveObjectRight("player"); }
	});
	
	$('.btn-a').on("touchstart", function() { 
		playerPrimaryAction(); 
	});

};


/////////////
//player movement
/////////////

moveObject = function(object, direction){

	changeObjectDirection(object, direction);
	var x = getObjectCurrentPositionX(object);
	x = stripPX(x); x = x - gridunitpx; x = addPX(x);
	var y = getObjectCurrentPositionY(object);
	y = stripPX(y); y = y - gridunitpx; y = addPX(y);

	if (direction == "left" || direction == "right"){ var amount = x; } 
	else { var amount = y; }
	
	var collide = objectCollisionDetection(object, direction);
	if (!collide){
		//console.log("Moving "+object+" "+direction+" by "+amount);
		$('.the-fucking-'+object).css(direction,amount);
		var block = getObjectCurrentBlock(object);
	} else {
		console.log("Can't move "+object+" "+direction+" by "+amount);	
	}
	
};

moveObjectLeft = function(object) {
	
	changeObjectDirection(object, "left");
	var x = getObjectCurrentPositionX(object);
	x = stripPX(x);
	x = x - gridunitpx;
	x = addPX(x);
	var collide = objectCollisionDetection(object, "left");
	if (!collide){ 
		//console.log("Moving "+object+" left -- x="+x);
		$('.the-fucking-'+object).css("left",x); 
		var block = getObjectCurrentBlock(object);
	} else {
		console.log("Can't move "+object+" left -- x="+x);	
	}
	
};

moveObjectRight = function(object) {

	changeObjectDirection(object, "right");
	var x = getObjectCurrentPositionX(object);
	x = stripPX(x);
	x = x + gridunitpx;
	x = addPX(x);
	var collide = objectCollisionDetection(object, "right");
	if (!collide){ 
		//console.log("Moving "+object+" right -- x="+x);
		$('.the-fucking-'+object).css("left",x); 
		var block = getObjectCurrentBlock(object);
	} else {
		console.log("Can't move "+object+" right -- x="+x);	
	}
	
};

moveObjectUp = function(object) {
	changeObjectDirection(object, "up");
	var y = getObjectCurrentPositionY(object);
	y = stripPX(y);
	y = y - gridunitpx;
	y = addPX(y);
	var collide = objectCollisionDetection(object, "up");
	if (!collide){ 
		//console.log("Moving "+object+" up -- y="+y);
		$('.the-fucking-'+object).css("top",y); 
		var block = getObjectCurrentBlock(object);
	} else {
		console.log("Can't move "+object+" up -- y="+y);	
	}
};

moveObjectDown = function(object) {
	changeObjectDirection(object, "down");
	var y = getObjectCurrentPositionY(object);
	y = stripPX(y);
	y = y + gridunitpx;
	y = addPX(y);
	var collide = objectCollisionDetection(object, "down");
	if (!collide){ 
		//console.log("Moving "+object+" down -- y="+y);
		$('.the-fucking-'+object).css("top",y); 
		var block = getObjectCurrentBlock(object);
	} else {
		console.log("Can't move "+object+" down -- y="+y);	
	}
};

objectCollisionDetection = function(object, direction) {
	
	var block = getObjectCurrentBlock(object);
	var row = getObjectCurrentRow(object);
	var col = getObjectCurrentCol(object);
	
	switch (direction) {
		case "up": block = block - (mapwidth + 1); break;
		case "down": block = block + (mapwidth - 1); break;
		case "left": block = block - 2; break;
		case "right": block = block; break;
	}

	// Water
	if ( $('.block:eq('+block+')').hasClass('block-water') ) {
		return true;
		
	// Tree	
	} else if ( $('.block:eq('+block+')').hasClass('block-tree') ) {
		return true;
	
	// Rock
	} else if ( $('.block:eq('+block+')').hasClass('block-rock') ) {
		return true;
		
	// Wood
	} else if ( $('.block:eq('+block+')').hasClass('block-wood') ) {
		return true;
	
	// Fire
	} else if ( $('.block:eq('+block+')').hasClass('block-fire') ) {
		return true;
	
	// Closed Door
	} else if ( $('.block:eq('+block+')').hasClass('block-door-closed') ) {
		return true;
		
	// Map right border	
	} else if ( (direction == "right" ) && (col>=mapwidth) ) {
		return true;
		
	// Map left border	
	} else if ( (direction == "left" ) && (col<=1) ) {
		return true;
		
	// Map top border
	} else if ( (direction == "up" ) && (row<=1) ) {
		return true;
		
	// Map bottom border	
	} else if ( (direction == "down" ) && (row>=(mapheight*2)) ) {
		return true;
		
	// PineTree	
	} else if ( $('.block:eq('+block+')').hasClass('block-pinetree') ) {
		return true;
	
	// IceRock
	} else if ( $('.block:eq('+block+')').hasClass('block-icerock') ) {
		return true;
		
	// Ice Sliding
	//} else if ( $('.block:eq('+block+')').hasClass('block-ice') ) {
		//slidePlayer();
		//return true;
		
	//Bike Riding?
	
	//Skiiing?
		
	// Walkable land
	} else {
		return false;
	}
	
};

changeObjectDirection = function(object, direction) {

	console.log("changing "+object+" direction to "+direction);
	var selecteditem = getSelectedItem();
	
	//animated items
	var playergraphic;
	if ( (selecteditem == "sword" || selecteditem == "shovel" || selecteditem == "bike" || selecteditem == "skiis") && object == "player" ){ 
		playergraphic = "-"+selecteditem;
	} else {
		playergraphic = "";
	}

	switch (direction) {
		case "up":
			$('.the-fucking-'+object).removeClass(object+"-direction-down"+playergraphic+" "+object+"-direction-left"+playergraphic+" "+object+"-direction-right"+playergraphic);
			$('.the-fucking-'+object).addClass(object+"-direction-up"+playergraphic);
			break;
		case "down":
			$('.the-fucking-'+object).removeClass(object+"-direction-up"+playergraphic+" "+object+"-direction-left"+playergraphic+" "+object+"-direction-right"+playergraphic);
			$('.the-fucking-'+object).addClass(object+"-direction-down"+playergraphic);
			break;
		case "left":
			$('.the-fucking-'+object).removeClass(object+"-direction-up"+playergraphic+" "+object+"-direction-down"+playergraphic+" "+object+"-direction-right"+playergraphic);
			$('.the-fucking-'+object).addClass(object+"-direction-left"+playergraphic);
			break;
		case "right":
			$('.the-fucking-'+object).removeClass(object+"-direction-up"+playergraphic+" "+object+"-direction-left"+playergraphic+" "+object+"-direction-down"+playergraphic);
			$('.the-fucking-'+object).addClass(object+"-direction-right"+playergraphic);
			break;
	}
	
};

getObjectDirection = function(object) {

	var direction;
	var selecteditem = getSelectedItem();
	
	var playergraphic;
	if ( (selecteditem == "sword" || selecteditem == "shovel" || selecteditem == "bike" || selecteditem == "skiis") && object == "player" ){ 
		playergraphic = "-"+selecteditem;
	} else {
		playergraphic = "";
	}
	
	if ($('.the-fucking-'+object).hasClass(object+"-direction-down"+playergraphic)) {
		direction = "down";
	} else if ($('.the-fucking-'+object).hasClass(object+"-direction-up"+playergraphic)) {
		direction = "up";
	} else if ($('.the-fucking-'+object).hasClass(object+"-direction-left"+playergraphic)) {
		direction = "left";
	} else if ($('.the-fucking-'+object).hasClass(object+"-direction-right"+playergraphic)) {
		direction = "right";
	}
	
	return direction;
	
};


/////////////
//player actions
/////////////



playerPrimaryAction = function() { 
	
	console.log("Player primary action");
	 
	//find block that the player is facing
	var direction = getObjectDirection("player");
	var playerblock = getObjectCurrentBlock("player");
	var block = getObjectCurrentBlock("player");
	
	switch (direction) {
		case "up": block = block - (mapwidth+1); break;
		case "down": block = block + (mapwidth-1); break;
		case "left": block = block - 2; break;
		case "right": block = block; break;
	}
	
	var blocktype = getBlockType(block);
	var selecteditem = getSelectedItem();
	
	//item swing animations
	if (selecteditem == "sword" || selecteditem == "shovel"){
	
		var swingclass = "player-direction-"+direction+"-"+selecteditem+"-swing";
		$(".the-fucking-player").addClass("player-direction-"+direction+"-"+selecteditem+"-swing");
		
		var swinganimation = setTimeout(removeSwingClass, 100);
		
		function removeSwingClass(swingclass) {
			$(".the-fucking-player").removeClass("player-direction-"+direction+"-"+selecteditem+"-swing");
		}
		
		var playerblock = getObjectCurrentBlock("player");
		
		
		if ($('.the-fucking-enemy').length != 0) {
			var enemyblock = getObjectCurrentBlock("enemy");
			console.log("hitblock:"+block+" enemyblock:"+enemyblock+" playerblock:"+playerblock);
			
			if (block == enemyblock || enemyblock == playerblock){
				console.log("killed enemy!");
				killEnemy(1);
			}
		}
	
	//throw frisbee
	} else if (selecteditem == "frisbee"){
	
		throwFrisbee(block, direction);
	
	}
	
	$('.block:eq('+block+')').animate({ opacity: 0.9 }, 50, function() {
		
		//console.log("play sound");
		
		//hit animation
		$('.block:eq('+block+')').css("opacity","1");
		var selecteditem = getSelectedItem();
		
		//digging - forest map
		if ( (getSelectedItem() == "shovel") && ((blocktype == "grass") || (blocktype == "dirt")) ){
			console.log("dig!");
			//chance of digging a diamond
			var r = Math.random();
			if (r < 0.5) {
				console.log("diamond!");
				changeBlockType(block, "diamond-hole");
			} else {
				changeBlockType(block, "hole");
			}
			addToInventory(blocktype, 2);
			addToInventory('dirt', 2);
		
		//digging - winter map
		} else if ( getSelectedItem() == "shovel" && ( blocktype == "snow" || blocktype == "frozendirt" || blocktype == "ice" ) ){
		
			//chance of digging gold
			var r = Math.random();
			if (r < 0.2) {
				console.log("gold!");
				changeBlockType(block, "gold-hole");
			} else if (r < 0.4) {
				console.log("silver!");
				changeBlockType(block, "silver-hole");
			} else {
				changeBlockType(block, "snowhole");
			}
			addToInventory(blocktype, 2);
			addToInventory('frozendirt', 2);
			
		}
		
		//check for placable block on map
		if ( (blocktype == "grass") || (blocktype == "dirt") || (blocktype == "hole") ||
		     (blocktype == "snow") || (blocktype == "frozendirt") || (blocktype == "ice") ) {
			
			//check for selected placable block in inventory
			
			console.log('selected item is '+selecteditem);
			
			//placable blocks: trees, rocks, wood, fire, doors, dirt, water, frozendirt, snow, diamond, gold, pinetree
			if ( 	selecteditem == "rock" ||
					selecteditem == "tree" ||
					selecteditem == "wood" ||
					selecteditem == "fire" ||
					selecteditem == "door" ||
					selecteditem == "grass" ||
					selecteditem == "water" ||
					selecteditem == "ice" ||
					selecteditem == "dirt" ||
					selecteditem == "frozendirt" ||
					selecteditem == "snow" ||
					selecteditem == "pinetree" ||
					selecteditem == "icerock" ||
					selecteditem == "silver" ||
					selecteditem == "gold" ||
					selecteditem == "diamond"
				){
			
				console.log('a placable item is selected');
				removeFromInventory(selecteditem);
				changeBlockType(block, selecteditem);
				
			}
			
		}
		
		//fill holes and water
		if ( (blocktype == "hole") || (blocktype == "water") || (blocktype == "snowhole") ) {

			if (
				selecteditem == "grass" ||
				selecteditem == "dirt" || 
				selecteditem == "frozendirt" || 
				selecteditem == "snow"
			) {
				console.log("fill hole/water with dirt or snow");
				changeBlockType(block, getSelectedItem());
				removeFromInventory(getSelectedItem());
				growGrass(block);
				if(blocktype=="water"){ addToInventory("water", 1); }
			}
			
		}
		
		//pickup trees, rocks, wood, fire, diamonds, gold, 
		if ((blocktype == "tree") ||
			(blocktype == "rock") ||
			(blocktype == "wood") ||
			(blocktype == "fire") ||
			(blocktype == "diamond-hole") ||
			(blocktype == "gold-hole") ||
			(blocktype == "silver-hole") ||
			(blocktype == "diamond") ||
			(blocktype == "gold") ||
			(blocktype == "silver") ||
			(blocktype == "pinetree") ||
			(blocktype == "icerock") ){
			
			var changeblocktotype = "dirt";
		
			if (blocktype == "diamond-hole") { blocktype = "diamond"; changeblocktotype = "hole"; } 
			else if (blocktype == "gold-hole") { blocktype = "gold"; changeblocktotype = "snowhole"; } 
			else if (blocktype == "silver-hole") { blocktype = "silver"; changeblocktotype = "snowhole"; }
			
			addToInventory(blocktype, "1");
			changeBlockType(block, changeblocktotype);
			growGrass(block);
			
		}
		
		//open/close doors
		if (blocktype == "door-closed") {
			changeBlockType(block, "door-open");
		} else if (blocktype == "door-open") {
			changeBlockType(block, "door-closed");
		}
		
	});
	
};

throwFrisbee = function(startblock, direction) {
	
	console.log("Create Frisbee");
	//var enemystartblock = 0;
	//$('.the-fucking-frisbee').remove();
	$('.the-fucking-map').append('<div class="the-fucking-frisbee"></div>');
	initProjectile("frisbee", startblock, direction);
	
};

initProjectile = function(object, startblock, direction) {

	stopProjectile();

	console.log("Start velocity for " + object + " travelling " + direction + " from block #" + startblock);
	
	var topstart = getBlockTopByID(startblock);
	var leftstart = getBlockLeftByID(startblock);
	topstart = addPX(topstart);
	leftstart = addPX(leftstart);
	
	$('.the-fucking-'+object).css("top",topstart);
	$('.the-fucking-'+object).css("left",leftstart);

	var t = 0;
	var maxdistance = 15;
	var projectilebrain = setTimeout(projectileMotion, projectilespeed);
	
	function projectileMotion() {
	
		switch (direction) {
			case "up": moveObjectUp(object); break;
			case "down": moveObjectDown(object); break;
			case "left": moveObjectLeft(object); break;
			case "right": moveObjectRight(object); break;
		}
				
		//limit
		if (t > maxdistance) {
			console.log("projectile stopped :(");
			stopProjectile();
		} else {
			t++;
			projectilebrain = setTimeout(projectileMotion, projectilespeed); // repeat thought
		}
		
	}
	
	function stopProjectile() {
		clearTimeout(projectilebrain);
		$('.the-fucking-'+object).remove();
	}

};


/////////////
//map interactions
/////////////


changeBlockType = function(block, newtype) {

	console.log("changing block "+block+" to "+newtype);
	$('.block:eq('+block+')').removeClass("block-grass block-rock block-dirt block-fire block-water block-tree block-hole block-wood block-door-closed block-door-open block-diamond-hole block-diamond block-gold-hole block-gold block-pinetree block-icerock block-ice block-snow block-snowhole block-frozendirt");
	$('.block:eq('+block+')').addClass("block block-"+newtype);
	$('.block:eq('+block+')').attr("data-blocktype", newtype);

};

growGrass = function(block) {
	
	console.log("growing grass at block" + block);
	
	$('.block:eq('+block+')').animate({
      	backgroundColor: "#36ac2a"
  	}, 10000, function() {
  		console.log("grass has been grown at block "+block+", calling changeBlockType()");
  		changeBlockType(block, "grass");
  	});
	
};


/////////////
//inventory
/////////////


addToInventory = function(blocktype, quantitytoadd) {
	
	if(!quantitytoadd) { quantitytoadd == "1"; }
	quantitytoadd = parseInt(quantitytoadd);
	
	var slotwithsameitem = $('.the-fucking-inventory > .block-'+blocktype).index();
	
	// add to slot with matching item
	if ( slotwithsameitem != -1 ) {
	
		console.log("adding "+quantitytoadd+" "+blocktype+" to stack in inv.");
		var quantity = $('.the-fucking-inventory > div:eq('+slotwithsameitem+')').html();
		quantity = parseInt(quantity) + quantitytoadd;
		$('.the-fucking-inventory > div:eq('+slotwithsameitem+')').html(quantity);
		
	// add to empty slot
	} else {
	
		console.log("adding "+quantitytoadd+" "+blocktype+" to empty slot in inv.");
		$('.the-fucking-inventory > .empty').first().addClass('block block-'+blocktype);
		$('.the-fucking-inventory > .empty').first().attr('data-blocktype', blocktype);
		$('.the-fucking-inventory > .empty').first().html(quantitytoadd);
		
		var index = $('.the-fucking-inventory > .empty').first().index();
		index = index + 1;
		
		$('.the-fucking-inventory > .empty').first().removeClass('empty');
		
	}
	
};

removeFromInventory = function(blocktype) {
	
	//minus one item from stack
	var quantity = $('.the-fucking-inventory > .block-'+blocktype).html();
	quantity = parseInt(quantity) - 1;
	$('.the-fucking-inventory > .block-'+blocktype).html(quantity);
	
	//alert(quantity);
	
	//empty slot if stack runs out for items
	if (quantity == 0) {
		var slotindex = $('.the-fucking-inventory > .block-'+blocktype).index();
		//alert("make arrow empty"+slotindex);
		
		$('.the-fucking-inventory > .block-'+blocktype).addClass('empty');
		$('.the-fucking-inventory > .block-'+blocktype).attr('data-blocktype', 'empty');
		$('.the-fucking-inventory > .block-'+blocktype).removeClass('block block-'+blocktype);
		
	}
	
};


/////////////
//crafting table
/////////////


moveItemToCraftingTable = function(blocktype) {

	if ( $('.the-fucking-crafting-table > .slot-1').hasClass("empty") ) {
	
		$('.the-fucking-crafting-table > .slot-1').addClass("block-"+blocktype);
		$('.the-fucking-crafting-table > .slot-1').removeClass("empty");
		$('.the-fucking-crafting-table > .slot-1').attr('data-blocktype', blocktype);
		$('.the-fucking-crafting-table > .slot-1').html("1");
		removeFromInventory(blocktype);
		
	} else if ( $('.the-fucking-crafting-table > .slot-2').hasClass("empty") ) {
	
		$('.the-fucking-crafting-table > .slot-2').addClass("block-"+blocktype);
		$('.the-fucking-crafting-table > .slot-2').removeClass("empty");
		$('.the-fucking-crafting-table > .slot-2').attr('data-blocktype', blocktype);
		$('.the-fucking-crafting-table > .slot-2').html("1");
		removeFromInventory(blocktype);
		
	} else if ( $('.the-fucking-crafting-table > .slot-3').hasClass("empty") ) {
	
		$('.the-fucking-crafting-table > .slot-3').addClass("block-"+blocktype);
		$('.the-fucking-crafting-table > .slot-3').removeClass("empty");
		$('.the-fucking-crafting-table > .slot-3').attr('data-blocktype', blocktype);
		$('.the-fucking-crafting-table > .slot-3').html("1");
		removeFromInventory(blocktype);
		
	}	

	checkCraftingTableForItem();
	
};

removeAllItemsFromCraftingTable = function() {

	$('.the-fucking-crafting-table > div').removeClass("block block-tree block-wood block-guitar block-rock block-shovel block-fire block-sword block-door-closed block-diamond block-frisbee block-gold block-dirt block-water block-pinetree block-icerock block-ice block-snow block-frozendirt");
	$('.the-fucking-crafting-table > div').attr("data-blocktype", "empty");
	$('.the-fucking-crafting-table > div').addClass("empty");
	$('.the-fucking-crafting-table > div').html("0");
	
};

checkCraftingTableForItem = function() {

	console.log("Check for Craftable Item");
	
	var slot1type = $('.the-fucking-crafting-table > .slot-1').attr("data-blocktype");
	var slot2type = $('.the-fucking-crafting-table > .slot-2').attr("data-blocktype");
	var slot3type = $('.the-fucking-crafting-table > .slot-3').attr("data-blocktype");
	var recipe = slot1type + slot2type + slot3type;

	createCraftedItem = function(blocktype, amount) {
		if (amount == null){ amount = 1; }
		$('.the-fucking-crafted-item > .slot').addClass("block block-"+blocktype);
		$('.the-fucking-crafted-item > .slot').attr('data-blocktype', blocktype);
		$('.the-fucking-crafted-item > .slot').removeClass("empty");
		$('.the-fucking-crafted-item > .slot').html(amount);
	};

	switch (recipe) {
		case "treeemptyempty": createCraftedItem("wood",3); break;
		case "treetreeempty": createCraftedItem("wood",6); break;
		case "treetreetree": createCraftedItem("wood",10); break;
		case "rockwoodwood": createCraftedItem("shovel",1); break;
		case "rockrockwood": createCraftedItem("sword",1); break;
		case "woodwoodrock": createCraftedItem("fire",5); break;
		case "woodwoodwood": createCraftedItem("door",5); break;
		case "treewoodwood": createCraftedItem("guitar",1); break;
		case "woodwooddiamond": createCraftedItem("frisbee",1); break;
		case "treewooddiamond": createCraftedItem("bike",1); break;
		case "treetreediamond": createCraftedItem("skiis",1); break;
		default:
			$('.the-fucking-crafted-item > .slot').removeClass("block block-wood block-shovel block-sword block-fire block-door block-guitar block-frisbee block-bike block-skiis");
			$('.the-fucking-crafted-item > .slot').addClass("empty");
			$('.the-fucking-crafted-item > .slot').attr('data-blocktype', 'empty');
			$('.the-fucking-crafted-item > .slot').html("0");
	}	
};


/////////////
//sound and instruments
/////////////

guitarFirstNote = true;

playGuitarSound = function(freq) {

	//unlock winter map
	if ((guitarFirstNote == true) && ($('.the-fucking-winter-map').length == 0)){ 
		drawNewWinterMap(); 
		guitarFirstNote = false; 
	}

	sin = T("sin", freq);
	env = T("adsr", 10, 500);
	syn = T("*", sin, env).play();
	sin.bang();
	env.bang();
	
};

playMusic = function(){

	var mml = T("mml", "t100 o3 $ l2 a l1 <b0<d0g+>> l2 d l1 <a0<c+0f+>> l2 a l1 <b0<d0g+>> l2 f l1 <a0<c+0f+>>");
	            
	mml.synth = T("efx.reverb");
	mml.synthdef = function(freq, opts) {
	    var synth = T("*", T("+", 
	                       T("tri", freq - 1, 0.25)),
	                       T("adsr", "24db", 100, 2500, 0.6, 1500));
	    synth.keyon = function(opts) {
	        synth.args[1].bang();
	    };
	    synth.keyoff = function(opts) {
	        synth.args[1].keyoff();
	    };
	    return synth;
	};
	 
	mml.synth.onplay = function() {
	    mml.on().bang();
	};
	mml.synth.onpause = function() {
	    mml.off();
	};
	 
	mml.synth.play();
	
}
		

/////////////
//helper classes
/////////////


getSelectedItem = function() {
	var blocktype = $('.the-fucking-inventory > .selected-item').attr("data-blocktype");
	return blocktype;
};
getBlockType = function(block) {
	var blocktype = $('.block:eq('+block+')').attr("data-blocktype");	
	return blocktype;
};
getBlockLeftByID = function(block) {
	var column = block % mapwidth;
	column = column;
	var leftpx = column * gridunitpx;
	return leftpx;
	//alert(leftpx);
};
getBlockTopByID = function(block) {
	var row = block / mapwidth;
	row = parseInt(row);
	var toppx = row * gridunitpx;
	//console.log("block "+block+", row"+row+", toppx"+toppx);
	return toppx;
};
getObjectCurrentPositionX = function(object) {
	var x = $('.the-fucking-'+object).css("left");
	return x;
};
getObjectCurrentPositionY = function(object) {
	var y = $('.the-fucking-'+object).css("top");
	return y;
};
getObjectCurrentCol = function(object) {
	var x = getObjectCurrentPositionX(object);
	x = stripPX(x);
	var y = getObjectCurrentPositionY(object);
	y = stripPX(y);
	var col = x / gridunitpx;
	col = parseInt(col);
	col = col + 1;
	return col;
};
getObjectCurrentRow = function(object) {
	var y = getObjectCurrentPositionY(object);
	y = stripPX(y);
	var row = y / gridunitpx;
	row = parseInt(row);
	row = row + 1;
	return row;
};
getObjectCurrentBlock = function(object) {
	var row = getObjectCurrentRow(object);
	var col = getObjectCurrentCol(object);
	var block = (row * mapwidth) - mapwidth;
	block = block + col;
	//console.log(object+" is at block# "+block);
	return block;
};
stripPX = function(css) {
	px = css.replace( /px/g , "" );
	px = parseInt(px);
	return px;
};
addPX = function(css) {
	px = css.toString() + "px";
	return px;
};

$(document).ready(function() {
	setMapSize();
	loadGame();
	setupKeyboardEvents();
	setupMouseEvents();
	setupControlPadEvents();
});