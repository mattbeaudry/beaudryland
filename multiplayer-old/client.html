<!DOCTYPE html>
<html>
    <head>
        <title>Chat</title>
        <link rel="stylesheet" href="http://yui.yahooapis.com/3.3.0/build/cssreset/reset-min.css">
        <link href="http://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/blocks.css">
        <link rel="stylesheet" href="css/svg-items.css">

        <style type="text/css">

            /* Global */
            html, body { height: 100%; }
            body { font-family: sans-serif; }
			
			/* Beaudrychat */
			.map {
				
				width: 800px;
				height: 600px;
				position: fixed;
				top: 10%;
				left: 10%;
			}
            .maps-wrap {
                position:absolute;
                width:800px;
                height:600px;
            }
			.player {
				background-color:pink;
				width:20px;
				height:20px;
				position:relative;
				top:80px;
				left:200px;
			}
			
			/* Chat example styles */
            #join-form { padding: 1em; }
            #nick-input { margin-bottom: 1em; }
            #nick-error { display: none; color: #d00; }
            #chat { display: none; height: 100%; }
            #main { width: 80%; height: 100%; float: left; }
            #messages { height: 90%; overflow-y: scroll; background-color: #eee; }
            #message-form { height: 10%; }
            #message-input { width: 100%; height: 100%; padding: 0 1em; border: none; outline: none; }
            #users {
	            width: 16%;
				height: 46%;
				float: left;
				padding: 2%;
				background-color: #ddd;
			}
            .sender { font-weight: bold; }
            .system-message { font-style: italic; }
            
        </style>
    </head>

    <body class="version-multiplayer">

        <form id="join-form">
            <label for="nick-input">Choose a nickname:</label><br />
            <input id="nick-input" />
            <div id="nick-error">That nickname is already in use, please choose something different.</div>
        </form>

        <div class="map">
            
        </div>
        
        <div class="maps-wrap"></div>

        <div id="chat">
            <div id="main">
                <ul id="messages"></ul>
                <form id="message-form">
                    <input id="message-input" />
                </form>
            </div>
            <ul id="users"></ul>
        </div>

        <script id="userTemplate" type="text/x-jquery-tmpl">
            <li id="user-${user}">${user}</li>
        </script>

        <script id="chatMessageTemplate" type="text/x-jquery-tmpl">
            <li><span class="sender">${sender}</span>: ${message}</li>
        </script>

        <script id="systemMessageTemplate" type="text/x-jquery-tmpl">
            <li class="system-message">${message}</li>
        </script>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <script src="../js/beaudryland.js"></script>

        <script type="text/javascript">


            $(document).ready(function() {

                // Give focus to the nickname input when the page loads
                $("#nick-input").focus();

                // Create a connection to the server
                var socket = io.connect(document.URL);

                /* Handle submission of the join form, try to join the chat-room */
                $("#join-form").submit(function(ev) {

                    // Prevent the browser from submitting the form via HTTP
                    ev.preventDefault();

                    // Check that a nickname has been entered
                    var nick = $("#nick-input").val();
                    if (nick) {

                        // Send a request to join the chat-room
                        socket.emit("join", nick, function(successful, users) {
                            if (successful) {





                                // Hide the join form and show the main chat interface
                                $("#join-form").hide();
                                $("#chat").show();

                                // Display a welcome message
                                var message = "Welcome, " + nick;
                                $("#systemMessageTemplate").tmpl({message: message}).appendTo("#messages");

                                // Display the list of connected users on the page
                                $.each(users, function(i, user) {
                                    $("#userTemplate").tmpl({user: user}).appendTo("#users");
                                    createPlayer(user);
                                });

                                // Give focus to the message input so the user can start entering a message
                                $("#message-input").focus();
                                
                                
                                // draw map on newly joined players screen
                                alert("trying to draw map");
                                mapdata = '';
                                //var mapdata = 50;
                                var mapdata = new Array();
                                mapdata[0] = maphtml;
                                //maphtml = $.parseHTML(maphtml);
                                socket.emit("updatemap", mapdata);


 





                                
                                /* beaudrychat */
                                function stripPX(css) {
									px = css.replace( /px/g , "" );
									px = parseInt(px);
									return px;
								}
								
								function addPX(css) {
									px = css.toString() + "px";
									return px;
								}
								
								function movePlayer(direction) {
									
									var currentPosX = $('.player-'+nick).css('left');
									var currentPosY = $('.player-'+nick).css('top');
								
									if (direction == "right" || direction == "left") {
									
										currentPosX = stripPX(currentPosX);
										if (direction == "right") {
											currentPosX = currentPosX + 20;
										} else {
											currentPosX = currentPosX - 20; 
										}
										currentPosX = addPX(currentPosX);
										$('.player-'+nick).css('left',currentPosX);
										
									} else if (direction == "up" || direction == "down") {
									
										currentPosY = stripPX(currentPosY); 
										if (direction == "down") {
											currentPosY = currentPosY + 20; 
										} else {
											currentPosY = currentPosY - 20; 
										}
										currentPosY = addPX(currentPosY);
										$('.player-'+nick).css('top',currentPosY);
										
									}
									
									var position = new Array();
									position[0] = currentPosX;
									position[1] = currentPosY;
									position[2] = nick;
									
									//var jsonposition = JSON.stringify(position);
									socket.emit("moveplayer", position);
									
								}
								
								function createPlayer(name) {
									
                                	$('.map').append('<div class="player player-'+name+'"></div>');
                                	$('.player-'+name).css("top","0px");
                                	$('.player-'+name).css("left","0px");
                                	
                                	var color;
                                	var r = Math.random();
                                	if (r<0.1) {
                                		color = "blue";
                                	} else if (r<0.2) {
                                		color = "pink";
                                	} else if (r<0.3) {
                                		color = "purple";
                                	} else if (r<0.4) {
                                		color = "orange";
                                	} else if (r<0.5) {
                                		color = "green";
                                	} else if (r<0.6) {
                                		color = "grey";
                                	} else if (r<0.7) {
                                		color = "red";
                                	} else if (r<0.8) {
                                		color = "teal";
                                	} else if (r<0.9) {
                                		color = "yellow";
                                	} else {
                                		color = "lime";
                                	}
                                	  
                                	$('.player-'+name).css("backgroundColor",color);
                                	                              	
                                }
                                //createPlayer(nick);
                                
                                window.addEventListener('keydown', function(event) {
	                                switch (event.keyCode) {
										case 37: /* LEFT ARROW */
											movePlayer("left");
											break;
										case 38: /* UP ARROW */
											movePlayer("up");
											break;
										case 39: /* RIGHT ARROW */
											movePlayer("right");
											break;
										case 40: /* DOWN ARROW */
											movePlayer("down");
											break;
											
									}
								});
                                
                                /* Move a player */
                                socket.on("moveplayer", function(position) {
                                
									var playername = position.position[2];
									var playerclass = ".player-"+playername;
									var playerleft = position.position[0];
									var playertop = position.position[1];
									
									console.log("Move "+playername+": "+playerleft+playertop);
									
									$(playerclass).css('left',playerleft);
									$(playerclass).css('top',playertop);
                                    
                                });
                                
                                /* Update Map */
                                socket.on("updatemap", function(mapdata) {
                                    
                                    /*
                                    var playername = position.position[2];
                                    var playerclass = ".player-"+playername;
                                    var playerleft = position.position[0];
                                    var playertop = position.position[1];
                                    */
                                    
                                    //console.log("Move "+playername+": "+playerleft+playertop);
                                    
                                    //$(playerclass).css('left',playerleft);
                                    //$(playerclass).css('top',playertop);

                                    //alert("updating map");
                                    //console.log(mapdata.mapdata[0]);
                                    //console.log(maphtml.position[1]);
                                    //var html = $.parseHTML(maphtml);
                                    //console.log('mapHTML:'+html);
                                    $('.maps-wrap').append(mapdata.mapdata[0]);
                                    
                                });
                                
                                                             
                                
                                
                                /* Send chat messages */
                                $("#message-form").submit(function(ev) {
                                    // Prevent the browser from submitting the form via HTTP
                                    ev.preventDefault();

                                    // Send the message to the server
                                    socket.emit("chat", $("#message-input").val());

                                    // Clear the text-box
                                    $("#message-input").val("");
                                });


                                /* Handle chat messages */
                                socket.on("chat", function(message) {

                                    // Inject the message into the DOM
                                    $("#chatMessageTemplate").tmpl(message).appendTo("#messages");

                                    // Auto-scroll the message pane
                                    $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());

                                });


                                /* Handle users joining */
                                socket.on("user-joined", function(user) {

                                    // Add to the on-page list of users
                                    $("#userTemplate").tmpl({user: user}).appendTo("#users");

                                    // Display a message in the main chat stream
                                    var message = user + " joined";
                                    $("#systemMessageTemplate").tmpl({message: message}).appendTo("#messages");

                                    // Auto-scroll the message pane
                                    $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());
                                    
                                    createPlayer(user);

                                });


                                /* Handle users leaving */
                                socket.on("user-left", function(user) {

                                    // Remove from the on-page list of users
                                    $("#user-" + user).remove();

                                    // Display a message in the main chat stream
                                    var message = user + " left";
                                    $("#systemMessageTemplate").tmpl({message: message}).appendTo("#messages");

                                    // Auto-scroll the message pane
                                    $("#messages").scrollTop($("#messages").prop("scrollHeight") - $("#messages").height());

                                });
                                
                                

                            // If the request to join was rejected, show an error message
                            } else {
                                $("#nick-error").show();
                            }
                        });
                    }
                });                
                
            });
        </script>
    </body>
</html>
